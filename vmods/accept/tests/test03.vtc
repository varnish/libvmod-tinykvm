varnishtest "Check basic matching against more specific regions tags"


server s1 {} -start

varnish v1 -vcl+backend {

	import accept;
        sub vcl_init {
		new lang = accept.rule("en");
		lang.add("en");
		lang.add("fr");
		lang.add("de");
		lang.add("it");
		lang.add("es");
		lang.add("pl");
        }

	sub vcl_recv {
		set req.http.x-accept-language = lang.filter(req.http.accept-language);
		return(synth(200));

	}
	sub vcl_synth {
		set resp.http.returned-language = req.http.x-accept-language;
	}

} -start


client c1 {
	txreq -url "/" -hdr "Accept-Language: da,zh-guoyu;q=0.9,cel-gaulish;q=0.8"
	rxresp	
	expect resp.http.returned-language == "en"

	txreq -url "/" -hdr "Accept-Language: en,fr;q=0.9en-US;q=0.8"
	rxresp	
	expect resp.http.returned-language == "en"

	txreq -url "/fr" -hdr "Accept-Language: fr,en-US;q=0.8,en;q=0.7"
	rxresp	
	expect resp.http.returned-language == "fr"

	txreq -url "/fr" -hdr "Accept-Language: fr-FR,en-US;q=0.8,en;q=0.7"
	rxresp	
	expect resp.http.returned-language == "fr"


	# Expected Polish in second, french is returned (quality 0.8)
	txreq -url "/" -hdr "Accept-Language: az-Arab,pl-PL;q=0.9,fr;q=0.8,en-US;q=0.7"
	rxresp	
	expect resp.http.returned-language == "pl"
} -run
