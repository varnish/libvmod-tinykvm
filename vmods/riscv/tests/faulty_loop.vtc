varnishtest "RISC-V Faulty Loop Test"

shell {
clang-10 -O1 -Wall -Wextra -target riscv32 -march=rv32imfd -ffreestanding -nostdlib -c ${testdir}/${testname}.cpp -o /tmp/${testname}.o
ld.lld-10 -Ttext=0x120000 --undefined=on_recv /tmp/${testname}.o -o /tmp/${testname}
}

varnish v1 -vcl+backend {
vcl 4.1;
	import riscv;
	import std;

	backend default none;

	sub vcl_init {
		riscv.embed_tenants("""
			{
				"xpizza.com": {
					"filename": "/tmp/${testname}",
					"group": "test"
				}
			}
		""");
	}

	sub vcl_recv {
		if (!riscv.fork(req.http.Host, req.http.X-Debug)) {
			return (synth(403));
		}

		# Infinite loop will cause 503
		riscv.vcall(ON_REQUEST);

		return (synth(400));
	}
} -start

client c1 {
	txreq -url "/" -hdr "Host: xpizza.com"
	rxresp
	expect resp.status == 503
} -run
