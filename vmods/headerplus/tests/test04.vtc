varnishtest "Test headerplus.prefix/suffix()"

varnish v1 -vcl+backend {
	import headerplus;
	import std;

	backend default none;

	sub vcl_recv {
		return (synth(200));
	}

	sub vcl_synth {
		headerplus.init(req);
		headerplus.add("test", "inside");
		if (req.http.re) {
			if (req.http.remove) {
				headerplus.prefix("test", "X-", true);
			} else {
				headerplus.prefix("test", "X-", false);
			}
		} else if (req.http.remove) {
			headerplus.suffix("test", "-new", true);
		} else {
			headerplus.suffix("test", "-new", false);
		}
		headerplus.write();
	}

} -start

logexpect l1 -v v1 {
	expect *	1001 	VCL_Log  	"headerplus.write()"
	expect 0	= 	ReqUnset  	"test: a"
	expect 0	= 	ReqUnset 	"test:b"
	expect 0	= 	ReqUnset 	"test:ing"
	expect 0	= 	ReqUnset 	"test: d"
	expect 0	= 	ReqHeader  	"test-new: a"
	expect 0	= 	ReqHeader 	"test-new: b"
	expect 0	= 	ReqHeader 	"test-new: ing"
	expect 0	= 	ReqHeader 	"test-new: d"
	expect 0	= 	ReqHeader 	"test-new: inside"

	expect *	1002 	VCL_Log  	"headerplus.write()"
	expect 0	=	ReqHeader	"test: inside"
	expect 0	= 	ReqHeader  	"test-new: a"
	expect 0	= 	ReqHeader 	"test-new: b"
	expect 0	= 	ReqHeader 	"test-new: ing"
	expect 0	= 	ReqHeader 	"test-new: d"
	expect 0	= 	ReqHeader 	"test-new: inside"

	expect *	1003 	VCL_Log  	"headerplus.write()"
	expect 0	= 	ReqUnset  	"test: a"
	expect 0	= 	ReqUnset 	"test:b"
	expect 0	= 	ReqUnset 	"test:ing"
	expect 0	= 	ReqUnset 	"test: d"
	expect 0	= 	ReqHeader  	"X-test: a"
	expect 0	= 	ReqHeader 	"X-test: b"
	expect 0	= 	ReqHeader 	"X-test: ing"
	expect 0	= 	ReqHeader 	"X-test: d"
	expect 0	= 	ReqHeader 	"X-test: inside"

	expect *	1004 	VCL_Log  	"headerplus.write()"
	expect 0	=	ReqHeader	"test: inside"
	expect 0	= 	ReqHeader  	"X-test: a"
	expect 0	= 	ReqHeader 	"X-test: b"
	expect 0	= 	ReqHeader 	"X-test: ing"
	expect 0	= 	ReqHeader 	"X-test: d"
	expect 0	= 	ReqHeader 	"X-test: inside"
} -start

client c1 {
	txreq -hdr "test: a" -hdr "test:b " -hdr "test:ing" -hdr "test: d" \
	-hdr "remove: true"
	rxresp

	txreq -hdr "test: a" -hdr "test:b " -hdr "test:ing" -hdr "test: d"
	rxresp

	txreq -hdr "test: a" -hdr "test:b " -hdr "test:ing" -hdr "test: d" \
	-hdr "re: true" -hdr "remove: true"
	rxresp

	txreq -hdr "test: a" -hdr "test:b " -hdr "test:ing" -hdr "test: d" \
	-hdr "re: true"
	rxresp
} -run

logexpect l1 -wait
