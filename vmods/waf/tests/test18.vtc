varnishtest "Show CVE-2020-15598 fixed"
# This test will hang and timeout if the fix was not applied

shell {
	cat >${tmpdir}/test.conf <<-EOF
	SecRuleEngine On
	SecRequestBodyAccess On
	SecRule REQUEST_BODY "@rx ." "id:1000,phase:2,deny,capture,log,msg:'Numeric payload'"
	EOF
}

varnish v1 -arg "-p thread_pool_stack=92k" -vcl {
    include "${pwd}/waf.vcl";
    backend default none;

    sub vcl_init {
        varnish_waf.add_files("${tmpdir}/test.conf");
    }
} -start

client c1 {
    txreq -bodylen 1mb
    rxresp
    expect resp.status == 403
} -run

