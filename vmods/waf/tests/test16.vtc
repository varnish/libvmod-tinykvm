varnishtest "Check RespHeaders when RespBody not parseable"

shell {
	cat >${tmpdir}/test.conf <<-EOF
	SecRuleEngine On
	SecResponseBodyAccess On
	SecResponseBodyMimeType text/plain text/html text/xml
	SecRule RESPONSE_HEADERS:ABCD "test" "id:1,phase:3,deny,log"
	EOF
}

server s1 {
	rxreq
	txresp -hdr "ABCD: test" -hdr "Content-Type: audio"

	expect_close
	accept

	rxreq
	txresp -hdr "ABCD: test" -hdr "Content-Type: text/plain"
} -start

varnish v1 -arg "-p thread_pool_stack=92k" -vcl+backend {
	include "${pwd}/waf.vcl";

	sub vcl_init {
		varnish_waf.add_files("${tmpdir}/test.conf");
	}
} -start

client c1 {
	txreq -url /1
	rxresp
	expect resp.status == 403

	txreq -url /2
	rxresp
	expect resp.status == 403
} -run
