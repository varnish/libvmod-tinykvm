varnishtest "Test headerplus.append()"

server s1 {
	rxreq
	txresp -hdr "test: a" -hdr "test:b " -hdr "test:ing" -hdr "test: d"

	rxreq
	txresp -hdr "test: a" -hdr "test:b " -hdr "test:ing" -hdr "test: d"

	rxreq
	txresp -hdr "test: a" -hdr "test:b " -hdr "test:ing" -hdr "test: d"

	rxreq
	txresp

	rxreq
	txresp
} -start

varnish v1 -vcl+backend {
	import headerplus;

	sub vcl_recv {
		return (pass);
	}

	sub vcl_backend_response {
		if (!bereq.http.delim) {
			set bereq.http.delim = ", ";
		}

		headerplus.init(beresp);
		if (bereq.http.all) {
			headerplus.append("test", "val", bereq.http.delim, true);
		} else {
			headerplus.append("test", "val", bereq.http.delim);
		}
		headerplus.write();
	}
} -start

logexpect l1 -v v1 -i BerespHeader -i BerespUnset {
	# Headers coming from client/varnish
	expect *	1002 	BerespHeader  	"test: a"
	expect *	=	BerespHeader	"test:b"
	expect *	=	BerespHeader	"test:ing"
	expect *	=	BerespHeader	"test: d"
	expect *	=	BerespHeader	"Content-Length: 0"
	expect *	=	BerespHeader	"Date:.*"
	# Headerplus headers
	expect *	=	BerespUnset	"test: a"
	expect *	=	BerespHeader	"test: a, val"

	# Headers coming from client/varnish
	expect *	1004 	BerespHeader  	"test: a"
	expect *	=	BerespHeader	"test:b"
	expect *	=	BerespHeader	"test:ing"
	expect *	=	BerespHeader	"test: d"
	expect *	=	BerespHeader	"Content-Length: 0"
	expect *	=	BerespHeader	"Date:.*"
	# Headerplus headers
	expect *	=	BerespUnset	"test: a"
	expect *	=	BerespUnset	"test:b"
	expect *	=	BerespUnset	"test:ing"
	expect *	=	BerespUnset	"test: d"
	expect *	=	BerespHeader	"test: a, val"
	expect *	=	BerespHeader	"test: b, val"
	expect *	=	BerespHeader	"test: ing, val"
	expect *	=	BerespHeader	"test: d, val"

	# Headers coming from client/varnish
	expect *	1006 	BerespHeader  	"test: a"
	expect *	=	BerespHeader	"test:b"
	expect *	=	BerespHeader	"test:ing"
	expect *	=	BerespHeader	"test: d"
	expect *	=	BerespHeader	"Content-Length: 0"
	expect *	=	BerespHeader	"Date:.*"
	# Headerplus headers
	expect *	=	BerespUnset	"test: a"
	expect *	=	BerespUnset	"test:b"
	expect *	=	BerespUnset	"test:ing"
	expect *	=	BerespUnset	"test: d"
	expect *	=	BerespHeader	"test: a;;val"
	expect *	=	BerespHeader	"test: b;;val"
	expect *	=	BerespHeader	"test: ing;;val"
	expect *	=	BerespHeader	"test: d;;val"

	# Headers coming from client/varnish
	expect *	1008	BerespHeader	"Content-Length: 0"
	expect *	=	BerespHeader	"Date:.*"
	# Headerplus headers
	expect *	=	BerespHeader	"test: val"


	# Headers coming from client/varnish
	expect *	1010	BerespHeader	"Content-Length: 0"
	expect *	=	BerespHeader	"Date:.*"
	# Headerplus headers
	expect *	=	BerespHeader	"test: val"

} -start


client c1 {
	txreq 
	rxresp
	expect resp.http.test == "b"

	txreq -hdr "all: true"
	rxresp
	expect resp.http.test == "a, val"

	txreq -hdr "all: true" -hdr "delim: ;;"
	rxresp
	expect resp.http.test == "a;;val"

	txreq  -hdr "delim: ;;"
	rxresp
	expect resp.http.test == "val"

	txreq 
	rxresp
	expect resp.http.test == "val"
} -run

logexpect l1 -wait
