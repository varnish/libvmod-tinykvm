varnishtest "headerplus as_json"

varnish v1 -vcl {
	import headerplus;

	backend default none;

	sub vcl_recv {
		return (synth(200));
	}
	sub vcl_synth {
		headerplus.init(req);
		
		set resp.http.json1 = headerplus.as_json(ARRAY);
		set resp.http.json2 = headerplus.as_json(FIRST);
		set resp.http.json3 = headerplus.as_json(LAST);
		set resp.http.json4 = headerplus.as_json(ALL);
		
		headerplus.keep_regex("");
		set resp.http.json5 = headerplus.as_json(ARRAY);
		set resp.http.json6 = headerplus.as_json(FIRST);
		set resp.http.json7 = headerplus.as_json(LAST);
		set resp.http.json8 = headerplus.as_json(ALL);

		headerplus.keep("one");
		headerplus.keep("two");
		set resp.http.json9 = headerplus.as_json(ARRAY);
		set resp.http.json10 = headerplus.as_json(FIRST);
		set resp.http.json11 = headerplus.as_json(LAST);
		set resp.http.json12 = headerplus.as_json(ALL);

		headerplus.add("name", "k2");
		headerplus.keep("name");
		set resp.http.json13 = headerplus.as_json(ARRAY);
		set resp.http.json14 = headerplus.as_json(FIRST);
		set resp.http.json15 = headerplus.as_json(LAST);
		set resp.http.json16 = headerplus.as_json(ALL);
		
	}

} -start

client c1 {
	txreq -hdr "name: value" -hdr "name: value2" -hdr "one: 1" -hdr "two: 2"
	rxresp
	expect resp.http.json1 == {{"name":["value","value2"],"one":"1","two":"2","Host":"127.0.0.1","X-Forwarded-For":"127.0.0.1"}}
	expect resp.http.json2 == {{"name":"value","one":"1","two":"2","Host":"127.0.0.1","X-Forwarded-For":"127.0.0.1"}}
	expect resp.http.json3 == {{"name":"value2","one":"1","two":"2","Host":"127.0.0.1","X-Forwarded-For":"127.0.0.1"}}
	expect resp.http.json4 == {{"name":"value","name":"value2","one":"1","two":"2","Host":"127.0.0.1","X-Forwarded-For":"127.0.0.1"}}

	expect resp.http.json5 == "{}"
	expect resp.http.json6 == resp.http.json5
	expect resp.http.json7 == resp.http.json5
	expect resp.http.json8 == resp.http.json5

	expect resp.http.json9 == {{"one":"1","two":"2"}}
	expect resp.http.json10 == resp.http.json9
	expect resp.http.json11 == resp.http.json9
	expect resp.http.json12 == resp.http.json9
	
	expect resp.http.json13 == {{"name":["value","value2","k2"],"one":"1","two":"2"}}
	expect resp.http.json14 == {{"name":"value","one":"1","two":"2"}}
	expect resp.http.json15 == {{"name":"k2","one":"1","two":"2"}}
	expect resp.http.json16 == {{"name":"value","name":"value2","one":"1","two":"2","name":"k2"}}
} -run
